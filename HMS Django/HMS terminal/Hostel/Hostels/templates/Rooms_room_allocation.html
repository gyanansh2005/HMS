{% extends 'Rooms_base.html' %}
{% load static %}
{% block content %}
<link rel="stylesheet" href="{% static 'css/Rooms_base.css' %}">
<link rel="stylesheet" href="{% static 'css/Rooms_room_allocation.css' %}">
<div class="container">
    <h2>Room Allocation</h2>
    
    <form method="get" class="filter-form">
        {% csrf_token %}
        <div class="form-row">
            <div class="form-group">
                <label for="hostel">Select Hostel:</label>
                <select id="hostel" name="hostel" required>
                    <option value="" disabled selected>Select Hostel</option>
                    {% for hostel in hostels %}
                    <option value="{{ hostel.id }}" 
                        {% if selected_hostel == hostel.id|stringformat:"s" %}selected{% endif %}>
                        {{ hostel.name }}
                    </option>
                    {% endfor %}
                </select>
            </div>

            <div class="form-group">
                <label for="floor">Select Floor:</label>
                <select id="floor" name="floor" required>
                    <option value="" disabled selected>Select Floor</option>
                    <option value="1" {% if selected_floor == '1' %}selected{% endif %}>Floor 1</option>
                    <option value="2" {% if selected_floor == '2' %}selected{% endif %}>Floor 2</option>
                    <option value="3" {% if selected_floor == '3' %}selected{% endif %}>Floor 3</option>
                </select>
            </div>

            <div class="form-group">
                <label for="ac_type">AC Preference:</label>
                <select id="ac_type" name="ac_type">
                    <option value="" {% if not selected_ac_type %}selected{% endif %}>All</option>
                    <option value="ac" {% if selected_ac_type == 'ac' %}selected{% endif %}>AC</option>
                    <option value="non_ac" {% if selected_ac_type == 'non_ac' %}selected{% endif %}>Non-AC</option>
                </select>
            </div>
        </div>
        <button type="submit" class="btn">Apply Filters</button>
    </form>

    {% if selected_hostel and selected_floor %}
    <form method="post" class="allocation-form">
        {% csrf_token %}
        <input type="hidden" name="hostel" value="{{ selected_hostel }}">
        <input type="hidden" name="floor" value="{{ selected_floor }}">
        <input type="hidden" name="ac_type" value="{{ selected_ac_type|default_if_none:'' }}">
        
        <div class="form-group">
            <label for="student-name">Student Name:</label>
            <input type="text" id="student-name" name="student_name" required>
        </div>

        <div class="form-group">
            <label for="student-roll-no">Student Roll Number:</label>
            <input type="text" id="student-roll-no" name="student_roll_no" required>
        </div>

        <div class="form-group">
            <label for="selected-room-display">Selected Room:</label>
            <input type="text" id="selected-room-display" readonly 
                   value="{{ selected_room_display|default_if_none:'' }}">
            <input type="hidden" id="selected-room-number" name="room_number" 
                   value="{{ selected_room_number|default_if_none:'' }}">
            <input type="hidden" id="selected-room-type" name="room_type" 
                   value="{{ selected_room_type|default_if_none:'' }}">
        </div>

        <button type="submit" id="allocate-btn" class="btn" 
                {% if not selected_room_number %}disabled{% endif %}>
            Allocate Room
        </button>
        {% if selected_room_number %}
        <a href="{% url 'payment' %}" id="payment-link" class="btn">Proceed to Pay</a>
        {% endif %}
    </form>
    {% endif %}
    
    <div class="status-legend">
        <div class="legend-item">
            <div class="legend-color available-color"></div>
            <span>Available</span>
        </div>
        <div class="legend-item">
            <div class="legend-color selected-color"></div>
            <span>Selected</span>
        </div>
        <div class="legend-item">
            <div class="legend-color booked-color"></div>
            <span>Booked</span>
        </div>
    </div>

    <div class="room-status">
        <!-- 4 Sharing Rooms -->
        <h3>4 Sharing Availability</h3>
        <div class="room-grid" id="four-sharing-grid">
            {% for room in four_sharing_available %}
            <div class="room available" 
                 data-room-number="{{ room.number }}" 
                 data-room-type="four"
                 onclick="selectRoom(this, '{{ room.number }}', 'four')">
                <strong>Room {{ room.number }}</strong>
                <div>4 Sharing ({{ room.ac_type }})</div>
                <small>{{ room.beds_left }} bed{{ room.beds_left|pluralize }} left</small>
            </div>
            {% empty %}
            <div class="no-rooms">No available 4 Sharing rooms</div>
            {% endfor %}
            
            {% for room in four_sharing_booked %}
            <div class="room booked">
                <strong>Room {{ room.number }}</strong>
                <div>4 Sharing ({{ room.ac_type }})</div>
                <small>Fully booked</small>
            </div>
            {% endfor %}
        </div>
    
        <!-- Double Sharing Rooms -->
        <h3>Double Sharing Availability</h3>
        <div class="room-grid" id="double-sharing-grid">
            {% for room in double_sharing_available %}
            <div class="room available" 
                 data-room-number="{{ room.number }}" 
                 data-room-type="double"
                 onclick="selectRoom(this, '{{ room.number }}', 'double')">
                <strong>Room {{ room.number }}</strong>
                <div>Double Sharing ({{ room.ac_type }})</div>
                <small>{{ room.beds_left }} bed{{ room.beds_left|pluralize }} left</small>
            </div>
            {% empty %}
            <div class="no-rooms">No available Double Sharing rooms</div>
            {% endfor %}
            
            {% for room in double_sharing_booked %}
            <div class="room booked">
                <strong>Room {{ room.number }}</strong>
                <div>Double Sharing ({{ room.ac_type }})</div>
                <small>Fully booked</small>
            </div>
            {% endfor %}
        </div>
    
        <!-- Single Seater Rooms -->
        <h3>Single Seater Availability</h3>
        <div class="room-grid" id="single-seater-grid">
            {% for room in single_seater_available %}
            <div class="room available" 
                 data-room-number="{{ room.number }}" 
                 data-room-type="single"
                 onclick="selectRoom(this, '{{ room.number }}', 'single')">
                <strong>Room {{ room.number }}</strong>
                <div>Single Seater ({{ room.ac_type }})</div>
                <small>{{ room.beds_left }} bed{{ room.beds_left|pluralize }} left</small>
            </div>
            {% empty %}
            <div class="no-rooms">No available Single Seater rooms</div>
            {% endfor %}
            
            {% for room in single_seater_booked %}
            <div class="room booked">
                <strong>Room {{ room.number }}</strong>
                <div>Single Seater ({{ room.ac_type }})</div>
                <small>Fully booked</small>
            </div>
            {% endfor %}
        </div>
    </div>
</div>
<!-- Add this after your room allocation form -->
<div id="payment-options" class="payment-container" style="display: none;">
    <h3><i class="fas fa-credit-card"></i> Payment Options</h3>
    
    <div class="room-summary">
        <div class="summary-item">
            <span>Selected Room:</span>
            <strong id="display-selected-room">-</strong>
        </div>
        <div class="summary-item">
            <span>Room Type:</span>
            <strong id="display-room-type">-</strong>
        </div>
    </div>

    <div class="payment-methods">
        <div class="payment-card">
            <input type="radio" name="payment" id="full-payment" checked>
            <label for="full-payment">
                <span class="payment-title">Full Payment</span>
                <span class="payment-details" id="full-payment-amount">-</span>
                <span class="payment-badge">5% Discount</span>
            </label>
        </div>
        <div class="payment-card">
            <input type="radio" name="payment" id="installment">
            <label for="installment">
                <span class="payment-title">Installment Plan</span>
                <span class="payment-details" id="installment-amount">-</span>
                <span class="payment-note">(3 monthly payments)</span>
            </label>
        </div>
    </div>

    <div class="action-buttons">
        <button class="btn proceed-btn" id="pay-now-btn">
            <i class="fas fa-bolt"></i> Pay Now
        </button>
        <button class="btn outline-btn" id="pay-later-btn">
            <i class="far fa-clock"></i> Pay Later
        </button>
    </div>
</div>

<!-- Hidden form for payment data -->
<form id="payment-form" action="/process-payment" method="POST" target="_blank" style="display: none;">
    <input type="hidden" name="room_id" id="payment-room-id">
    <input type="hidden" name="amount" id="payment-amount">
    <input type="hidden" name="payment_type" id="payment-type">
</form>

<script>


function selectRoom(element, roomNumber, roomType) {
    // Update selected room display
    document.querySelectorAll('.room.selected').forEach(el => el.classList.remove('selected'));
    element.classList.add('selected');
    
    document.getElementById('selected-room-number').value = roomNumber;
    document.getElementById('selected-room-type').value = roomType;
    document.getElementById('selected-room-display').value = 
        `Room ${roomNumber} (${roomType.replace('four', '4-sharing').replace('double', 'Double sharing').replace('single', 'Single seater')})`;
    
    // Enable allocate button
    document.getElementById('allocate-btn').disabled = false;
    
    // Show payment link
    document.getElementById('payment-link').style.display = 'inline-block';
    
    // Submit form to persist selection
    const form = document.querySelector('.filter-form');
    form.action = "{% url 'room_allocation' %}";
    form.innerHTML += `<input type="hidden" name="room_number" value="${roomNumber}">`;
    form.innerHTML += `<input type="hidden" name="room_type" value="${roomType}">`;
    form.submit();
}

// Add polling functionality
let refreshInterval;

function startPolling() {
    refreshInterval = setInterval(updateRooms, 3000); // Poll every 3 seconds
}

function stopPolling() {
    clearInterval(refreshInterval);
}

// Modify existing updateRooms function
function updateRooms() {
    const hostelId = hostelSelect.value;
    const floor = floorSelect.value;
    const acType = acTypeSelect.value;

    if (!hostelId || !floor) return;

    fetch(`/get_room_details/?hostel_id=${hostelId}&floor=${floor}&ac_type=${acType}`)
        .then(res => res.json())
        .then(data => {
            document.querySelectorAll('.room-grid').forEach(grid => grid.innerHTML = '');
            
            data.rooms.forEach(room => {
                const grid = document.querySelector(`.room-type[data-type="${room.type}"] .room-grid`);
                const status = room.beds_left > 0 ? 'available' : 'booked';
                grid.innerHTML += `
                    <div class="room-card ${status}" data-room-id="${room.id}">
                        <div class="room-header">
                            <span>Room ${room.number}</span>
                            <span class="status">${status}</span>
                        </div>
                        <div class="room-details">
                            <p>${room.ac_type.toUpperCase()}</p>
                            <p class="beds-left">${room.beds_left} beds left</p>
                            <p>â‚¹${room.price}/month</p>
                        </div>
                    </div>
                `;
            });

            document.querySelectorAll('.room-card.available').forEach(card => {
                card.addEventListener('click', () => showRoomModal(card.dataset.roomId));
            });
        });
}

// Start polling when filters are selected
hostelSelect.addEventListener('change', () => {
    stopPolling();
    updateRooms();
    startPolling();
});

floorSelect.addEventListener('change', () => {
    stopPolling();
    updateRooms();
    startPolling();
});

acTypeSelect.addEventListener('change', () => {
    stopPolling();
    updateRooms();
    startPolling();
});

// Update booking function to handle response
function bookRoom(roomId) {
    fetch('/book_room/', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': getCookie('csrftoken')
        },
        body: JSON.stringify({ room_id: roomId })
    })
    .then(res => res.json())
    .then(data => {
        if (data.success) {
            // Update local room status immediately
            const roomCard = document.querySelector(`.room-card[data-room-id="${data.room.id}"]`);
            if (roomCard) {
                roomCard.querySelector('.status').textContent = data.room.beds_left > 0 ? 'available' : 'booked';
                roomCard.querySelector('.beds-left').textContent = `${data.room.beds_left} beds left`;
                roomCard.classList.toggle('available', data.room.beds_left > 0);
                roomCard.classList.toggle('booked', data.room.beds_left <= 0);
            }
            window.location.href = data.redirect;
        } else {
            alert(data.error);
        }
    });
}
</script>
{% endblock %}