{% extends 'Rooms_base.html' %}
{% load static %}
{% block content %}
<link rel="stylesheet" href="{% static 'css/Rooms_base.css' %}">
<link rel="stylesheet" href="{% static 'css/Rooms_room_allocation.css' %}">
<div class="container">
    <h2>Room Allocation</h2>
    
    <!-- Filter Section -->
    <form method="get" class="filter-form">
        {% csrf_token %}
        <div class="filter-row">
            <div class="filter-group">
                <label for="hostel"><i class="fas fa-building"></i> Hostel</label>
                <select id="hostel" name="hostel" required>
                    <option value="" disabled selected>Choose Hostel</option>
                    {% for hostel in hostels %}
                    <option value="{{ hostel.id }}">{{ hostel.name }}</option>
                    {% endfor %}
                </select>
            </div>

            <div class="filter-group">
                <label for="floor"><i class="fas fa-layer-group"></i> Floor</label>
                <select id="floor" name="floor" required disabled>
                    <option value="" disabled selected>Select hostel first</option>
                </select>
            </div>

            <div class="filter-group">
                <label for="ac_type"><i class="fas fa-snowflake"></i> AC Type</label>
                <select id="ac_type" name="ac_type">
                    <option value="">All Types</option>
                    <option value="ac">AC Rooms</option>
                    <option value="non_ac">Non-AC Rooms</option>
                </select>
            </div>
        </div>
    </form>

    <!-- Room Display Section -->
    <div class="room-display-container">
        <!-- Dynamic content will be loaded here -->
    </div>

    <!-- Allocation Form -->
    <form method="post" class="allocation-form" style="display: none;">
        {% csrf_token %}
        <input type="hidden" name="hostel" id="form-hostel">
        <input type="hidden" name="floor" id="form-floor">
        <input type="hidden" name="ac_type" id="form-ac_type">
        
        <div class="form-group">
            <label for="student-name">Student Name:</label>
            <input type="text" id="student-name" name="student_name" 
                   value="{{ user.get_full_name }}" required>
        </div>
    
        <div class="form-group">
            <label for="student-roll-no">Student Roll Number:</label>
            <input type="text" id="student-roll-no" name="student_roll_no" 
                   value="{{ user.roll_number }}" required>
        </div>

        <div class="form-group">
            <label for="selected-room-display">Selected Room:</label>
            <input type="text" id="selected-room-display" readonly>
            <input type="hidden" id="selected-room-number" name="room_number">
            <input type="hidden" id="selected-room-type" name="room_type">
        </div>

        <button type="submit" id="allocate-btn" class="btn" disabled>
            Allocate Room
        </button>
    </form>
</div>

<script>
document.addEventListener('DOMContentLoaded', () => {
    const hostelSelect = document.getElementById('hostel');
    const floorSelect = document.getElementById('floor');
    const acSelect = document.getElementById('ac_type');
    const roomContainer = document.querySelector('.room-display-container');
    const allocationForm = document.querySelector('.allocation-form');

    // Fetch floors when hostel changes
    hostelSelect.addEventListener('change', async () => {
        if (!hostelSelect.value) return;
        
        try {
            const response = await fetch(`/hostel/${hostelSelect.value}/floors/`);
            const data = await response.json();
            
            floorSelect.innerHTML = '<option value="" disabled selected>Select Floor</option>';
            data.floors.forEach(floor => {
                const option = document.createElement('option');
                option.value = floor;
                option.textContent = `Floor ${floor}`;
                floorSelect.appendChild(option);
            });
            floorSelect.disabled = false;
        } catch (error) {
            console.error('Error fetching floors:', error);
        }
    });

    // Fetch rooms when any filter changes
    async function fetchRooms() {
        if (!hostelSelect.value || !floorSelect.value) return;

        try {
            const params = new URLSearchParams({
                hostel: hostelSelect.value,
                floor: floorSelect.value,
                ac_type: acSelect.value
            });

            document.getElementById('form-hostel').value = hostelSelect.value;
            document.getElementById('form-floor').value = floorSelect.value;
            document.getElementById('form-ac_type').value = acSelect.value;

            const response = await fetch(`{% url 'get_available_rooms' %}?${params}`);
            const data = await response.json();
            updateRoomDisplay(data.rooms);
        } catch (error) {
            console.error('Error fetching rooms:', error);
        }
    }

    function updateRoomDisplay(rooms) {
        // Render all grids first
        roomContainer.innerHTML = `
            <div class="room-category four-sharing">
                <h3><i class="fas fa-users"></i> 4-Sharing Rooms</h3>
                <div class="room-grid" id="four-sharing-grid"></div>
            </div>
            <div class="room-category double-sharing">
                <h3><i class="fas fa-user-friends"></i> Double Sharing</h3>
                <div class="room-grid" id="double-sharing-grid"></div>
            </div>
            <div class="room-category single-seater">
                <h3><i class="fas fa-user"></i> Single Seater</h3>
                <div class="room-grid" id="single-seater-grid"></div>
            </div>
        `;

        // Populate grids after HTML is in the DOM
        populateRoomGrid('four', rooms);
        populateRoomGrid('double', rooms);
        populateRoomGrid('single', rooms);

        // Add event listeners only after cards are rendered
        document.querySelectorAll('.room-card').forEach(card => {
            card.addEventListener('click', handleRoomSelection);
        });
    }

    function populateRoomGrid(type, rooms) {
        const gridId = {
            'four': 'four-sharing-grid',
            'double': 'double-sharing-grid',
            'single': 'single-seater-grid'
        }[type];
        
        const grid = document.getElementById(gridId);
        if (!grid) {
            console.error(`Grid ${gridId} not found in DOM`);
            return;
        }

        const filteredRooms = rooms.filter(room => room.type === type);
        console.log(`Populating ${type} rooms:`, filteredRooms); // Debug log
        
        filteredRooms.forEach(room => {
            const roomCard = document.createElement('div');
            roomCard.className = `room-card ${room.beds_left > 0 ? 'available' : 'booked'}`;
            roomCard.dataset.roomId = room.id;
            roomCard.innerHTML = `
                <div class="room-header">
                    <span class="room-number">${room.number}</span>
                    <span class="ac-badge ${room.ac_type}">${room.ac_type.toUpperCase()}</span>
                </div>
                <div class="room-details">
                    <div class="capacity">
                        <i class="fas fa-bed"></i>
                        ${type === 'single' ? '1' : type === 'double' ? '2' : '4'} beds
                    </div>
                    <div class="availability">
                        ${room.beds_left} bed${room.beds_left !== 1 ? 's' : ''} left
                    </div>
                    <div class="price">
                        â‚¹${room.price}/month
                    </div>
                </div>
            `;
            grid.appendChild(roomCard);
        });

        if (filteredRooms.length === 0) {
            grid.innerHTML = '<div class="no-rooms">No rooms available</div>';
        }
    }

    function handleRoomSelection(event) {
        const roomCard = event.currentTarget;
        if (!roomCard || roomCard.classList.contains('booked')) return;

        document.querySelectorAll('.room-card').forEach(card => {
            card.classList.remove('selected');
        });

        roomCard.classList.add('selected');
        allocationForm.style.display = 'block';

        document.getElementById('selected-room-display').value = 
            `Room ${roomCard.querySelector('.room-number').textContent}`;
        document.getElementById('selected-room-number').value = 
            roomCard.querySelector('.room-number').textContent;
        document.getElementById('selected-room-type').value = 
            roomCard.closest('.room-category').classList.contains('four-sharing') ? 'four' :
            roomCard.closest('.room-category').classList.contains('double-sharing') ? 'double' : 'single';
        
        document.getElementById('allocate-btn').disabled = false;
    }

    // Event listeners for filters
    [floorSelect, acSelect].forEach(select => {
        select.addEventListener('change', fetchRooms);
    });
});

</script>

<style>
.room-display-container {
    margin-top: 2rem;
    display: flex;
    flex-direction: column;
    gap: 2rem;
}

.room-category {
    background: #f8f9fa;
    padding: 1.5rem;
    border-radius: 12px;
    box-shadow: 0 2px 8px rgba(0,0,0,0.1);
}

.room-category h3 {
    color: #2c3e50;
    margin-bottom: 1rem;
    display: flex;
    align-items: center;
    gap: 0.5rem;
}

.room-grid {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
    gap: 1.5rem;
}

.room-card {
    background: white;
    border-radius: 8px;
    padding: 1.2rem;
    cursor: pointer;
    transition: transform 0.2s, box-shadow 0.2s;
    border: 2px solid transparent;
}

.room-card:hover {
    transform: translateY(-2px);
    box-shadow: 0 4px 12px rgba(0,0,0,0.1);
}

.room-card.selected {
    border-color: #3498db;
    background: #f8f9fa;
}

.room-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 1rem;
}

.ac-badge {
    font-size: 0.8rem;
    padding: 0.2rem 0.5rem;
    border-radius: 4px;
    color: white;
}

.ac-badge.ac { background: #27ae60; }
.ac-badge.non_ac { background: #e74c3c; }

.room-details div {
    margin: 0.5rem 0;
    display: flex;
    align-items: center;
    gap: 0.5rem;
}

.booked {
    opacity: 0.6;
    cursor: not-allowed;
    background: #f8d7da;
}

.no-rooms {
    text-align: center;
    padding: 1rem;
    color: #7f8c8d;
}

.allocation-form {
    margin-top: 2rem;
    padding: 2rem;
    background: #f8f9fa;
    border-radius: 8px;
}
.single-seater .room-card {
    border-left: 4px solid var(--accent1);
}
.single-seater h3 i {
    color: var(--accent1);
}
</style>
{% endblock %}