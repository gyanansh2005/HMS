{% extends 'Rooms_base.html' %}
{% load static %}
{% block content %}

<link rel="stylesheet" href="{% static 'css/Rooms_profile.css' %}">
<div class="profile-container">
    <header class="profile-header">
        <h1>Your Profile</h1>
        <p class="header-tagline">Manage Your CampusNest Experience</p>
    </header>

    <div class="profile-content">
        <div class="profile-sidebar">
            <div class="profile-picture-container">
                {% if user.student_profile.profile_picture %}
                    <img src="{{ user.student_profile.profile_picture.url }}" alt="Profile Picture" class="profile-pic">
                {% else %}
                    <img src="{% static 'images/default_profile.png' %}" alt="Profile Picture" class="profile-pic">
                {% endif %}
                <form id="profile-picture-form" method="post" enctype="multipart/form-data" action="{% url 'edit_profile' %}">
                    {% csrf_token %}
                    <input type="file" id="profile-picture-upload" name="profile_picture" accept="image/*" style="display: none;">
                    <button type="button" class="btn edit" onclick="document.getElementById('profile-picture-upload').click()">
                        <i class="fas fa-camera"></i> Change Photo
                    </button>
                </form>
            </div>
            
            <h2>{{ user.get_full_name|default:user.username }}</h2>
            <p class="user-email">{{ user.email }}</p>
            
            <div class="about-me">
                <h3>About Me</h3>
                <p id="about-me-text">{{ user.student_profile.bio|default:"Tell us something about yourself..." }}</p>
                <button class="edit-btn" id="edit-bio-btn">Edit Bio</button>
                
                <div class="edit-form" id="edit-bio-form">
                    <textarea id="about-me-input" name="bio" rows="4">{{ user.student_profile.bio|default:"" }}</textarea>
                    <button class="save-btn" id="save-bio-btn">Save</button>
                    <button class="cancel-btn" id="cancel-bio-btn">Cancel</button>
                </div>
            </div>
        </div>

        <div class="profile-main">
            <div class="profile-section">
                <h2><i class="fas fa-home"></i> Hostel Details</h2>
                <div class="details-grid">
                    {% if allocation %}
                        <div class="detail-item">
                            <span>Room Number:</span>
                            <strong>{{ allocation.room.room_number }}</strong>
                        </div>
                        <div class="detail-item">
                            <span>Hostel:</span>
                            <strong>{{ allocation.room.hostel.name }}</strong>
                        </div>
                        <div class="detail-item">
                            <span>Floor:</span>
                            <strong>Floor {{ allocation.room.floor }}</strong>
                        </div>
                        <div class="detail-item">
                            <span>AC Type:</span>
                            <strong>{{ allocation.room.get_ac_type_display }}</strong>
                        </div>
                    
                        <div class="detail-item">
                            <span>Allocation Date:</span>
                            <strong>{{ allocation.allocation_date|date:"F d, Y" }}</strong>
                        </div>
                        <div class="detail-item">
                            <span>Status:</span>
                            <strong class="status-{{ allocation.status }}">{{ allocation.get_status_display }}</strong>
                        </div>
                    {% else %}
                        <div class="no-allocation">
                            <p>You don't have a room allocation yet.</p>
                            <a href="{% url 'room_allocation' %}" class="btn primary">Book a Room</a>
                        </div>
                    {% endif %}
                </div>
            </div>

            <div class="profile-section">
                <h2><i class="fas fa-user"></i> Personal Details</h2>
                <div class="details-grid">
                    <div class="detail-item">
                        <span>Full Name:</span>
                        <strong>{{ user.get_full_name }}</strong>
                    </div>
                    <div class="detail-item">
                        <span>Roll Number:</span>
                        <strong>{{ user.roll_number }}</strong>
                    </div>
                    <div class="detail-item">
                        <span>Contact Number:</span>
                        <strong>{{ user.student_profile.contact_number }}</strong>
                    </div>
                    <div class="detail-item">
                        <span>Email:</span>
                        <strong>{{ user.email }}</strong>
                    </div>
                    <div class="detail-item">
                        <span>Member Since:</span>
                        <strong>{{ user.date_joined|date:"F d, Y" }}</strong>
                    </div>
                </div>
            </div>

            <div class="profile-actions">
                <a href="{% url 'edit_profile' %}" class="btn primary">
                    <i class="fas fa-edit"></i> Edit Profile
                </a>
                <form action="{% url 'logout' %}" method="post" class="logout-form">
                    {% csrf_token %}
                    <button type="submit" class="btn danger">
                        <i class="fas fa-sign-out-alt"></i> Logout
                    </button>
                </form>
            </div>
        </div>
    </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    // Bio editing functionality
    const editBioBtn = document.getElementById('edit-bio-btn');
    const saveBioBtn = document.getElementById('save-bio-btn');
    const cancelBioBtn = document.getElementById('cancel-bio-btn');
    const editBioForm = document.getElementById('edit-bio-form');
    const aboutMeText = document.getElementById('about-me-text');
    const aboutMeInput = document.getElementById('about-me-input');

    editBioBtn.addEventListener('click', function() {
        aboutMeText.style.display = 'none';
        editBioBtn.style.display = 'none';
        editBioForm.style.display = 'block';
    });

    cancelBioBtn.addEventListener('click', function() {
        aboutMeText.style.display = 'block';
        editBioBtn.style.display = 'block';
        editBioForm.style.display = 'none';
    });

    saveBioBtn.addEventListener('click', function() {
        const newBio = aboutMeInput.value;
        fetch("{% url 'edit_profile' %}", {
            method: 'POST',
            headers: {
                'Content-Type': 'application/x-www-form-urlencoded',
                'X-CSRFToken': '{{ csrf_token }}'
            },
            body: `bio=${encodeURIComponent(newBio)}`
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                aboutMeText.textContent = newBio || "Tell us something about yourself...";
                aboutMeText.style.display = 'block';
                editBioBtn.style.display = 'block';
                editBioForm.style.display = 'none';
            }
        });
    });

    // Profile picture upload
    const profilePicUpload = document.getElementById('profile-picture-upload');
    profilePicUpload.addEventListener('change', function() {
        if (this.files && this.files[0]) {
            const form = document.getElementById('profile-picture-form');
            const formData = new FormData(form);
            
            fetch("{% url 'edit_profile' %}", {
                method: 'POST',
                body: formData,
                headers: {
                    'X-CSRFToken': '{{ csrf_token }}'
                }
            })
            .then(response => response.json())
            .then(data => {
                if (data.success && data.profile_picture_url) {
                    document.querySelector('.profile-pic').src = data.profile_picture_url;
                }
            });
        }
    });
});
</script>
{% endblock %}